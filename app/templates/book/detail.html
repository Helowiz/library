{% extends "layout.html" %}

{% block title %}{{ book.title }}{% endblock %}

{% block content %}

<div class="book-detail-container">
    <aside class="book-sidebar">
        <div class="detail-cover">
            {% if book.cover_url %}
            <img src="{{ book.cover_url }}" alt="Couverture">
            {% else %}
            <div
                style="height: 300px; background: #eee; display: flex; align-items: center; justify-content: center; color: #aaa;">
                No Image
            </div>
            {% endif %}
        </div>

        <div class="sidebar-section">
            <div class="sidebar-title">Fiche Technique</div>
            <div class="meta-item">
                <span class="meta-label">Format</span><span class="meta-value">{{ book.format.value }}</span>
            </div>
            {% if book.number_of_pages %}
                <div class="meta-item">
                    <span class="meta-label">Pages</span>
                    <span class="meta-value">{{ book.number_of_pages }}</span>
                </div>
            {% endif %}
            {% if book.publisher %}
                <div class="meta-item">
                    <span class="meta-label">Éditeur</span>
                    <span class="meta-value">{{ book.publisher }}</span>
                </div>
            {% endif %}
            <div class="meta-item">
                <span class="meta-label">Langue</span>
                <span class="meta-value">{{ book.language }}</span>
            </div>
        </div>

        {% if book.tags %}
            <div class="sidebar-section">
                <div class="sidebar-title">Genres</div>
                <div class="sidebar-tags">
                    {% for tag in book.tags %}
                        <span class="sidebar-tag">#{{ tag.name }}</span>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </aside>

    <main class="book-main-content">
        <header class="book-header">
            {% if book.series %}
                <div class="series-overline">
                    <span class="series-title">{{ book.series.title }}</span>
                    <span class="series-separator">//</span>
                    <span class="series-vol">VOL. {{ book.series_volume }}</span>
                </div>
            {% endif %}
            <div class="title-group">
                <h1>{{ book.title }}</h1>
                <div class="author-name">par <strong>{{ book.author.name }}</strong></div>
            </div>
        </header>

        <section class="actions-bar">
            {% set current_status = book.readings[0].status.name if book.readings else 'None' %}
            <form method="POST" action="{{ url_for('book.update_status', book_id=book.id) }}">
                <div class="status-selector-group">
                    <button type="submit" name="status" value="WISHLIST"
                        class="status-button status-wishlist {% if current_status == 'WISHLIST' %}active{% endif %}">
                        Wishlist
                    </button>
                    <button type="submit" name="status" value="TBR"
                        class="status-button status-tbr {% if current_status == 'TBR' %}active{% endif %}">
                        PAL
                    </button>
                    <button type="submit" name="status" value="READING"
                        class="status-button status-reading {% if current_status == 'READING' %}active{% endif %}">
                        En cours
                    </button>
                    <button type="submit" name="status" value="READ"
                        class="status-button status-read {% if current_status == 'READ' %}active{% endif %}">
                        Lu
                    </button>
                    <button type="submit" name="status" value="DNF"
                        class="status-button {% if current_status == 'DNF' %}active{% endif %}"
                        style="{% if current_status == 'DNF' %}background-color: var(--danger); color: white;{% endif %}">
                        Abandonné
                    </button>
                </div>
            </form>
        </section>

        <section>
            <h2 class="section-title">Synopsis</h2>
            <div class="synopsis-text">{{ book.synopsis or "Aucun résumé disponible." }}</div>
        </section>

        {% if book.quotes %}
        <section>
            <h2 class="section-title">Citations</h2>
            <div style="display: grid; gap: 1rem;">
                {% for quote in book.quotes %}
                <div
                    style="background: #fff; border: 1px solid #eee; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                    <div style="font-family: serif; font-size: 1.1rem; color: #555; line-height: 1.6;">« {{
                        quote.content }} »</div>
                    {% if quote.page_number %}
                    <div style="text-align: right; font-size: 0.8rem; color: #999; margin-top: 10px;">Page {{
                        quote.page_number }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <section>
            <h2 class="section-title">Journal de lecture</h2>
            {% if book.readings %}
            <div class="timeline">
                {% for session in book.readings %}
                <div class="timeline-item">
                    <div class="timeline-dot dot-{{ session.status.name }}"></div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="timeline-status">{{ session.status.value }}</span>
                            {% if session.rating %}<span style="color: #f1c40f; font-size: 0.9rem;">{{ "★" *
                                session.rating }}</span>{% endif %}
                            {% if session.is_reread %}<span class="reread-badge">Relecture</span>{% endif %}
                        </div>
                        <div class="timeline-date">
                            {% if session.finish_date %}Fini le {{ session.finish_date.strftime('%d/%m/%Y') }}
                            {% elif session.start_date %}Commencé le {{ session.start_date.strftime('%d/%m/%Y') }}
                            {% else %}Date inconnue{% endif %}
                        </div>
                        {% if session.review %}
                        <div class="timeline-review">{{ session.review }}</div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="color: #999; font-style: italic;">Aucune activité enregistrée.</p>
            {% endif %}
        </section>

    </main>
</div>
{% endblock %}